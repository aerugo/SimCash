# 3-Agent LSM Ring with Burst Arrivals - Triggers Cycle Detection
#
# Strategy to trigger LSM cycle detection:
# 1. Perfect ring topology: A→B→C→A
# 2. Burst arrivals in early ticks (time windows)
# 3. Extremely low opening balances ($500 each)
# 4. Zero credit limits
# 5. FIFO policies submit everything to Queue 2 immediately
#
# Expected LSM behavior:
# - Bilateral offsetting: Any A↔B, B↔C, or C↔A pairs
# - Cycle detection: A→B→C→A circular dependencies
# - Should see both bilateral_offsets > 0 AND cycles_settled > 0

simulation:
  ticks_per_day: 15
  num_days: 1
  rng_seed: 42

agents:
  # Bank A → Bank B
  - id: "BANK_A"
    opening_balance: 50000           # $500 - very tight
    credit_limit: 0                  # No credit - pure recycling
    policy:
      type: "Fifo"
    arrival_config:
      rate_per_tick: 8.0
      amount_distribution:
        type: "LogNormal"
        mean: 10.0                   # Median ~$220
        std_dev: 0.5
      counterparty_weights:
        BANK_B: 1.0                  # All to B (ring)
      deadline_range: [8, 15]
      priority: 5
      divisible: false
      time_windows:
        - tick_range: [0, 4]
          rate_multiplier: 4.0       # 32 tx/tick burst
        - tick_range: [5, 15]
          rate_multiplier: 0.2       # 1.6 tx/tick tail

  # Bank B → Bank C
  - id: "BANK_B"
    opening_balance: 50000           # $500 - very tight
    credit_limit: 0
    policy:
      type: "Fifo"
    arrival_config:
      rate_per_tick: 8.0
      amount_distribution:
        type: "LogNormal"
        mean: 10.0
        std_dev: 0.5
      counterparty_weights:
        BANK_C: 1.0                  # All to C (ring)
      deadline_range: [8, 15]
      priority: 5
      divisible: false
      time_windows:
        - tick_range: [0, 4]
          rate_multiplier: 4.0       # 32 tx/tick burst
        - tick_range: [5, 15]
          rate_multiplier: 0.2       # 1.6 tx/tick tail

  # Bank C → Bank A (completes ring)
  - id: "BANK_C"
    opening_balance: 50000           # $500 - very tight
    credit_limit: 0
    policy:
      type: "Fifo"
    arrival_config:
      rate_per_tick: 8.0
      amount_distribution:
        type: "LogNormal"
        mean: 10.0
        std_dev: 0.5
      counterparty_weights:
        BANK_A: 1.0                  # Back to A (completes ring: A→B→C→A)
      deadline_range: [8, 15]
      priority: 5
      divisible: false
      time_windows:
        - tick_range: [0, 4]
          rate_multiplier: 4.0       # 32 tx/tick burst
        - tick_range: [5, 15]
          rate_multiplier: 0.2       # 1.6 tx/tick tail

lsm_config:
  enable_bilateral: true             # Enable bilateral offsetting
  enable_cycles: true                # Enable cycle detection
  max_cycle_length: 4
  max_cycles_per_tick: 10

cost_rates:
  overdraft_bps_per_tick: 2.0
  delay_cost_per_tick_per_cent: 0.0004
  collateral_cost_per_tick_bps: 0.0012
  eod_penalty_per_transaction: 100000
  deadline_penalty: 50000
  split_friction_cost: 2500

# ============================================================================
# EXPECTED DYNAMICS
# ============================================================================
#
# Tick 0-4 (Burst Period):
# - Each bank receives ~32 transactions per tick
# - Total ~96 transactions per bank (~$21k value)
# - FIFO submits all to Queue 2 immediately
# - Only $500 balance each → massive Queue 2 backlog
# - Queue 2 fills with circular dependencies:
#   * A→B payments (need B's balance)
#   * B→C payments (need C's balance)
#   * C→A payments (need A's balance)
#
# LSM Activation:
# 1. Bilateral offsetting:
#    - If any bilateral pairs exist (rare in pure ring)
#    - Settles both directions with net flow
#
# 2. Cycle detection (MAIN FEATURE):
#    - Detects A→B→C→A cycles
#    - Example: A owes B $500, B owes C $400, C owes A $300
#    - Settles entire cycle with net flows:
#      * A→B: $200 net (500-300)
#      * B→C: $100 net (400-300)
#      * C→A: $0 net (300-300 offset)
#    - Saves $300 gross liquidity
#
# 3. Liquidity recycling:
#    - Settlements provide liquidity for more settlements
#    - Queue drains progressively
#
# Tick 5-15 (Tail Period):
# - Low arrival rate (~1.6 tx/tick)
# - Remaining queue clears via recycled liquidity
#
# Expected metrics:
# - total_lsm_releases > 0
# - bilateral_offsets ≥ 0 (if any A↔B, B↔C, or C↔A pairs occur)
# - cycles_settled > 0 (MAIN GOAL - circular A→B→C→A dependencies)
# - Queue 2 peak: 80-120 transactions
# - Settlement rate: 95-100%
