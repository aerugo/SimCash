# 6-Bank LSM Demonstration Scenario
#
# PURPOSE: Demonstrate LSM bilateral offsetting and cycle detection with minimal complexity
#
# DESIGN PHILOSOPHY:
# - Simple FIFO policies (no complex JSON logic that could fail)
# - Extreme liquidity constraint (force transactions into RTGS queue)
# - Symmetric bilateral flows (A→B and B→A create offsetting opportunities)
# - Circular payment patterns (A→B→C→A create cycle opportunities)
# - Small network (6 banks) makes it easy to understand and visualize
#
# EXPECTED BEHAVIOR:
# - Many transactions will fail immediate RTGS settlement
# - RTGS Queue 2 will fill up (20-50+ transactions)
# - Bilateral offsetting will trigger frequently (5-15 per 100 ticks)
# - Cycle detection will resolve gridlock (2-5 cycles per 100 ticks)
# - Settlement rate WITHOUT LSM: ~60-70%
# - Settlement rate WITH LSM: ~85-95%
#
# NETWORK STRUCTURE:
#
#   BANK_A ←→ BANK_B     (Bilateral pair: high volume, balanced flows)
#      ↓         ↓
#   BANK_C ←→ BANK_D     (Bilateral pair: medium volume, balanced flows)
#      ↓         ↓
#   BANK_E ←→ BANK_F     (Bilateral pair: low volume, balanced flows)
#
# Plus circular flows: A→C→E→A, B→D→F→B (creates 3-party cycles)
#
# RUN COMMANDS:
# 1. With LSM enabled (default):
#    uv run payment-sim run --config examples/configs/6_bank_lsm_demonstration.yaml --ticks 200
#
# 2. With LSM disabled (compare baseline):
#    Edit config to set enable_bilateral: false, enable_cycles: false, then run
#
# 3. Verbose output to see LSM activity:
#    uv run payment-sim run --config examples/configs/6_bank_lsm_demonstration.yaml --ticks 50 --verbose

simulation:
  ticks_per_day: 100
  num_days: 2
  rng_seed: 12345

# ============================================================================
# AGENTS: 6 banks with minimal liquidity and FIFO policies
# ============================================================================

agents:
  # ==========================================================================
  # PAIR 1: BANK_A ↔ BANK_B (High volume bilateral flow)
  # ==========================================================================
  - id: "BANK_A"
    opening_balance: 500000       # $5,000 - Very constrained
    credit_limit: 300000          # $3,000 credit
    policy:
      type: "Fifo"                # Simple: submit everything immediately
    arrival_config:
      rate_per_tick: 0.8          # ~80 transactions per 100 ticks
      amount_distribution:
        type: "Uniform"
        min: 200000               # $2,000
        max: 800000               # $8,000
      counterparty_weights:
        BANK_B: 0.50              # 50% to B (bilateral partner)
        BANK_C: 0.30              # 30% to C (cycle: A→C→E→A)
        BANK_D: 0.10
        BANK_E: 0.05
        BANK_F: 0.05
      deadline_range: [30, 80]
      priority: 5
      divisible: false

  - id: "BANK_B"
    opening_balance: 500000       # $5,000
    credit_limit: 300000          # $3,000 credit
    policy:
      type: "Fifo"
    arrival_config:
      rate_per_tick: 0.8
      amount_distribution:
        type: "Uniform"
        min: 200000               # $2,000
        max: 800000               # $8,000
      counterparty_weights:
        BANK_A: 0.50              # 50% to A (bilateral partner)
        BANK_D: 0.30              # 30% to D (cycle: B→D→F→B)
        BANK_C: 0.10
        BANK_E: 0.05
        BANK_F: 0.05
      deadline_range: [30, 80]
      priority: 5
      divisible: false

  # ==========================================================================
  # PAIR 2: BANK_C ↔ BANK_D (Medium volume bilateral flow)
  # ==========================================================================
  - id: "BANK_C"
    opening_balance: 400000       # $4,000
    credit_limit: 250000          # $2,500 credit
    policy:
      type: "Fifo"
    arrival_config:
      rate_per_tick: 0.6          # ~60 transactions per 100 ticks
      amount_distribution:
        type: "Uniform"
        min: 150000               # $1,500
        max: 600000               # $6,000
      counterparty_weights:
        BANK_D: 0.50              # 50% to D (bilateral partner)
        BANK_E: 0.30              # 30% to E (cycle: A→C→E→A)
        BANK_A: 0.10
        BANK_B: 0.05
        BANK_F: 0.05
      deadline_range: [30, 80]
      priority: 5
      divisible: false

  - id: "BANK_D"
    opening_balance: 400000       # $4,000
    credit_limit: 250000          # $2,500 credit
    policy:
      type: "Fifo"
    arrival_config:
      rate_per_tick: 0.6
      amount_distribution:
        type: "Uniform"
        min: 150000               # $1,500
        max: 600000               # $6,000
      counterparty_weights:
        BANK_C: 0.50              # 50% to C (bilateral partner)
        BANK_F: 0.30              # 30% to F (cycle: B→D→F→B)
        BANK_A: 0.10
        BANK_B: 0.05
        BANK_E: 0.05
      deadline_range: [30, 80]
      priority: 5
      divisible: false

  # ==========================================================================
  # PAIR 3: BANK_E ↔ BANK_F (Lower volume bilateral flow)
  # ==========================================================================
  - id: "BANK_E"
    opening_balance: 300000       # $3,000
    credit_limit: 200000          # $2,000 credit
    policy:
      type: "Fifo"
    arrival_config:
      rate_per_tick: 0.5          # ~50 transactions per 100 ticks
      amount_distribution:
        type: "Uniform"
        min: 100000               # $1,000
        max: 500000               # $5,000
      counterparty_weights:
        BANK_F: 0.50              # 50% to F (bilateral partner)
        BANK_A: 0.30              # 30% to A (cycle: A→C→E→A closes)
        BANK_B: 0.10
        BANK_C: 0.05
        BANK_D: 0.05
      deadline_range: [30, 80]
      priority: 5
      divisible: false

  - id: "BANK_F"
    opening_balance: 300000       # $3,000
    credit_limit: 200000          # $2,000 credit
    policy:
      type: "Fifo"
    arrival_config:
      rate_per_tick: 0.5
      amount_distribution:
        type: "Uniform"
        min: 100000               # $1,000
        max: 500000               # $5,000
      counterparty_weights:
        BANK_E: 0.50              # 50% to E (bilateral partner)
        BANK_B: 0.30              # 30% to B (cycle: B→D→F→B closes)
        BANK_A: 0.10
        BANK_C: 0.05
        BANK_D: 0.05
      deadline_range: [30, 80]
      priority: 5
      divisible: false

# ============================================================================
# LSM CONFIGURATION: Fully enabled to demonstrate effectiveness
# ============================================================================

lsm_config:
  enable_bilateral: true          # Enable bilateral offsetting (A↔B netting)
  enable_cycles: true              # Enable cycle detection and settlement
  max_cycle_length: 4              # Detect cycles up to length 4 (A→B→C→D→A)
  max_cycles_per_tick: 10          # Settle up to 10 cycles per tick

# ============================================================================
# COST CONFIGURATION: Standard rates
# ============================================================================

cost_rates:
  overdraft_bps_per_tick: 0.5
  delay_cost_per_tick_per_cent: 0.0001
  collateral_cost_per_tick_bps: 0.0003
  eod_penalty_per_transaction: 500000
  deadline_penalty: 250000
  split_friction_cost: 5000

# ============================================================================
# EXPECTED RESULTS
# ============================================================================
#
# Liquidity Analysis (per bank):
# - BANK_A/B: $8,000 total liquidity, median tx $5,000 → 1.6x ratio (STRESS!)
# - BANK_C/D: $6,500 total liquidity, median tx $3,750 → 1.7x ratio
# - BANK_E/F: $5,000 total liquidity, median tx $3,000 → 1.7x ratio
#
# With rate_per_tick = 0.5-0.8 and 50% going to bilateral partner:
# - Each bank receives ~0.3-0.4 incoming tx/tick
# - Each bank sends ~0.5-0.8 outgoing tx/tick
# - Net outflow of ~0.2-0.4 tx/tick → liquidity drains quickly
# - RTGS queue builds up within 5-10 ticks
#
# Bilateral Offsetting Opportunities:
# - A→B and B→A: ~40 tx each direction per 100 ticks → many offset pairs
# - C→D and D→C: ~30 tx each direction per 100 ticks → many offset pairs
# - E→F and F→E: ~25 tx each direction per 100 ticks → many offset pairs
# - Expected: 15-25 bilateral offsets per 100 ticks
#
# Cycle Detection Opportunities:
# - Cycle 1: A→C→E→A (each leg ~12 tx per 100 ticks)
# - Cycle 2: B→D→F→B (each leg ~9 tx per 100 ticks)
# - Expected: 3-8 cycles detected per 100 ticks
#
# Performance Metrics:
# - WITHOUT LSM (disable in config):
#   - Settlement rate: 60-70%
#   - Final queue depth: 40-80 transactions
#   - EOD penalties: HIGH
#
# - WITH LSM (default):
#   - Settlement rate: 85-95%
#   - Final queue depth: 10-25 transactions
#   - EOD penalties: LOW-MEDIUM
#   - LSM releases: 20-35 per 100 ticks
#
# - IMPROVEMENT:
#   - +25-30% settlement rate
#   - -60-70% queue depth
#   - Demonstrates clear value of LSM mechanism
#
# ============================================================================
# HOW TO TEST LSM EFFECTIVENESS
# ============================================================================
#
# 1. Baseline (LSM disabled):
#    Edit this file: set enable_bilateral: false, enable_cycles: false
#    Run: uv run payment-sim run --config examples/configs/6_bank_lsm_demonstration.yaml
#    Record: settlement_rate, final queue depths, total_cost
#
# 2. Bilateral only:
#    Edit: enable_bilateral: true, enable_cycles: false
#    Run and record metrics
#
# 3. Full LSM (both enabled):
#    Edit: enable_bilateral: true, enable_cycles: true
#    Run and record metrics
#
# 4. Compare results:
#    - Expect ~15-20% improvement from bilateral alone
#    - Expect ~5-10% additional improvement from cycles
#    - Total improvement: ~25-30% better settlement rate
#
# 5. Verbose output to see LSM in action:
#    uv run payment-sim run --config examples/configs/6_bank_lsm_demonstration.yaml --ticks 50 --verbose
#    Look for: "LSM Bilateral Offset" and "LSM Cycle" in output
