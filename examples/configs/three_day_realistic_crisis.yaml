# Three-Day Realistic Crisis Scenario
#
# NARRATIVE: "A Challenging Week Compressed"
#
# This scenario demonstrates payment system features under realistic stress:
# - Meaningful LSM activation (not forced starvation)
# - Collateral posting and withdrawal
# - Cost accruals under stress
# - Crisis and recovery arc
# - Sustainable (NOT gridlock death spiral)
#
# CALIBRATION PHILOSOPHY:
# - Start with comfortable liquidity (Day 1 baseline)
# - Inject targeted stress (Day 2 morning)
# - Force LSM via strategic large payments (creates Queue 2 buildup)
# - Allow recovery (Day 3)
# - Result: 92-96% settlement, moderate costs, clear LSM demonstration
#
# KEY DIFFERENCES FROM 5-DAY VERSION:
# - Shorter duration (3 days vs 5) = less compounding
# - Moderate transaction rates (not ultra-low)
# - Strategic large payments to FORCE Queue 2 buildup
# - Higher arrival rate surges to create temporary pressure
# - Explicit collateral posting via policy parameters (agents post earlier)

simulation:
  ticks_per_day: 100       # 100 ticks/day for granularity
  num_days: 3              # 300 total ticks
  rng_seed: 42             # Deterministic

# ============================================================================
# AGENTS - Moderate Capitalization (4 banks for simplicity)
# ============================================================================

agents:
  # METRO_CENTRAL - Large Money Center Bank (REDUCED LIQUIDITY)
  - id: "METRO_CENTRAL"
    opening_balance: 12000000         # $120,000 (reduced 40%)
    credit_limit: 10000000            # $100,000 credit (increased slightly to prevent deep overdraft)
    policy:
      type: "FromJson"
      json_path: "backend/policies/cautious_liquidity_preserver.json"  # CHANGED to conservative
    arrival_config:
      rate_per_tick: 0.25             # ~25 tx/day
      amount_distribution:
        type: "LogNormal"
        mean: 10.5                    # ~$500 median
        std_dev: 0.9
      counterparty_weights:
        CORRESPONDENT_HUB: 0.35
        REGIONAL_TRUST: 0.35
        MOMENTUM_CAPITAL: 0.30
      deadline_range: [30, 70]
      priority: 6
      divisible: false

  # REGIONAL_TRUST - Regional Bank (REDUCED LIQUIDITY, splitting enabled)
  - id: "REGIONAL_TRUST"
    opening_balance: 10000000         # $100,000 (reduced 38%)
    credit_limit: 9000000             # $90,000 credit (increased to prevent overdraft)
    policy:
      type: "FromJson"
      json_path: "backend/policies/agile_regional_bank.json"
    arrival_config:
      rate_per_tick: 0.28             # ~28 tx/day
      amount_distribution:
        type: "Uniform"
        min: 50000                    # $500
        max: 400000                   # $4,000
      counterparty_weights:
        CORRESPONDENT_HUB: 0.35
        METRO_CENTRAL: 0.35
        MOMENTUM_CAPITAL: 0.30
      deadline_range: [25, 65]
      priority: 5
      divisible: true

  # MOMENTUM_CAPITAL - Investment Bank (REDUCED LIQUIDITY)
  - id: "MOMENTUM_CAPITAL"
    opening_balance: 11000000         # $110,000 (reduced 39%)
    credit_limit: 10000000            # $100,000 credit (increased for balance)
    policy:
      type: "FromJson"
      json_path: "backend/policies/balanced_cost_optimizer.json"
    arrival_config:
      rate_per_tick: 0.30             # ~30 tx/day
      amount_distribution:
        type: "LogNormal"
        mean: 9.8                     # ~$300 median
        std_dev: 1.3
      counterparty_weights:
        CORRESPONDENT_HUB: 0.35
        METRO_CENTRAL: 0.35
        REGIONAL_TRUST: 0.30
      deadline_range: [20, 60]
      priority: 7
      divisible: false

  # CORRESPONDENT_HUB - Central Correspondent Bank (REDUCED LIQUIDITY, splitting enabled)
  - id: "CORRESPONDENT_HUB"
    opening_balance: 13000000         # $130,000 (reduced 41%)
    credit_limit: 12000000            # $120,000 credit (increased to prevent deep overdraft)
    policy:
      type: "FromJson"
      json_path: "backend/policies/smart_splitter.json"
    arrival_config:
      rate_per_tick: 0.32             # ~32 tx/day
      amount_distribution:
        type: "Uniform"
        min: 80000                    # $800
        max: 450000                   # $4,500
      counterparty_weights:
        METRO_CENTRAL: 0.35
        REGIONAL_TRUST: 0.35
        MOMENTUM_CAPITAL: 0.30
      deadline_range: [28, 68]
      priority: 6
      divisible: true

# ============================================================================
# SCENARIO EVENTS - Three-Day Crisis Timeline
# ============================================================================

scenario_events:
  # ========================================================================
  # DAY 1 (Ticks 0-99): Normal Operations - Baseline
  # ========================================================================
  # No events - establish baseline behavior
  # Expected: ~95-98% settlement, minimal LSM, low costs

  # ========================================================================
  # DAY 2 (Ticks 100-199): Crisis - Strategic Stress Injection
  # ========================================================================

  # Morning (tick 105): Market surge begins (REDUCED)
  - type: GlobalArrivalRateChange
    multiplier: 1.6  # 60% increase (reduced from 2.5×)
    schedule:
      type: OneTime
      tick: 105

  # Tick 110: Large payment METRO → HUB (REDUCED)
  - type: CustomTransactionArrival
    from_agent: METRO_CENTRAL
    to_agent: CORRESPONDENT_HUB
    amount: 3500000   # $35,000 (reduced from $60K)
    priority: 9
    deadline: 35      # Longer deadline
    is_divisible: false
    schedule:
      type: OneTime
      tick: 110

  # Tick 115: Large payment HUB → REGIONAL (cycle setup, STAGGERED)
  - type: CustomTransactionArrival
    from_agent: CORRESPONDENT_HUB
    to_agent: REGIONAL_TRUST
    amount: 3200000   # $32,000 (reduced from $55K)
    priority: 9
    deadline: 35
    is_divisible: true  # Can be split
    schedule:
      type: OneTime
      tick: 115

  # Tick 120: Large payment REGIONAL → MOMENTUM (cycle continues, STAGGERED)
  - type: CustomTransactionArrival
    from_agent: REGIONAL_TRUST
    to_agent: MOMENTUM_CAPITAL
    amount: 2900000   # $29,000 (reduced from $50K)
    priority: 9
    deadline: 35
    is_divisible: true
    schedule:
      type: OneTime
      tick: 120

  # Tick 125: Large payment MOMENTUM → METRO (completes cycle, STAGGERED)
  - type: CustomTransactionArrival
    from_agent: MOMENTUM_CAPITAL
    to_agent: METRO_CENTRAL
    amount: 2600000   # $26,000 (reduced from $45K)
    priority: 9
    deadline: 35
    is_divisible: false
    schedule:
      type: OneTime
      tick: 125

  # Tick 120: Collateral haircut - REGIONAL (adds stress)
  - type: CollateralAdjustment
    agent: REGIONAL_TRUST
    delta: -3000000  # Lose $30,000 (25% of credit)
    schedule:
      type: OneTime
      tick: 120

  # Tick 122: Collateral haircut - MOMENTUM
  - type: CollateralAdjustment
    agent: MOMENTUM_CAPITAL
    delta: -3500000  # Lose $35,000 (25% of credit)
    schedule:
      type: OneTime
      tick: 122

  # Midday (tick 135): Activity surge peaks (REDUCED)
  - type: GlobalArrivalRateChange
    multiplier: 2.0  # Peak stress (reduced from 3.0×)
    schedule:
      type: OneTime
      tick: 135

  # Tick 145: Bilateral offset opportunity (REDUCED)
  - type: CustomTransactionArrival
    from_agent: METRO_CENTRAL
    to_agent: MOMENTUM_CAPITAL
    amount: 2500000   # $25,000 (reduced from $40K)
    priority: 8
    deadline: 28      # Longer deadline
    is_divisible: false
    schedule:
      type: OneTime
      tick: 145

  - type: CustomTransactionArrival
    from_agent: MOMENTUM_CAPITAL
    to_agent: METRO_CENTRAL
    amount: 2300000   # $23,000 (bilateral opportunity, reduced from $38K)
    priority: 8
    deadline: 28
    is_divisible: false
    schedule:
      type: OneTime
      tick: 147

  # Afternoon (tick 160): Activity moderates
  - type: GlobalArrivalRateChange
    multiplier: 1.5  # Still elevated
    schedule:
      type: OneTime
      tick: 160

  # Late day (tick 185): Return to normal
  - type: GlobalArrivalRateChange
    multiplier: 1.0
    schedule:
      type: OneTime
      tick: 185

  # ========================================================================
  # DAY 3 (Ticks 200-299): Recovery and Final Stress Test
  # ========================================================================

  # Morning (tick 205): Collateral restoration begins
  - type: CollateralAdjustment
    agent: REGIONAL_TRUST
    delta: 2000000   # Restore $20,000 (67% of loss)
    schedule:
      type: OneTime
      tick: 205

  - type: CollateralAdjustment
    agent: MOMENTUM_CAPITAL
    delta: 2500000   # Restore $25,000 (71% of loss)
    schedule:
      type: OneTime
      tick: 205

  # Midday (tick 240): Final stress test - 3-agent cycle (REDUCED)
  - type: CustomTransactionArrival
    from_agent: METRO_CENTRAL
    to_agent: CORRESPONDENT_HUB
    amount: 3000000   # $30,000 (reduced from $45K)
    priority: 8
    deadline: 35
    is_divisible: true
    schedule:
      type: OneTime
      tick: 240

  - type: CustomTransactionArrival
    from_agent: CORRESPONDENT_HUB
    to_agent: REGIONAL_TRUST
    amount: 2800000   # $28,000 (reduced from $42K)
    priority: 8
    deadline: 35
    is_divisible: true
    schedule:
      type: OneTime
      tick: 242

  - type: CustomTransactionArrival
    from_agent: REGIONAL_TRUST
    to_agent: METRO_CENTRAL
    amount: 2600000   # $26,000 (reduced from $39K)
    priority: 8
    deadline: 35
    is_divisible: true
    schedule:
      type: OneTime
      tick: 244

  # Tick 255: Market activity test (REDUCED)
  - type: GlobalArrivalRateChange
    multiplier: 1.4    # Reduced from 1.8×
    schedule:
      type: OneTime
      tick: 255

  # Afternoon (tick 270): Markets normalize
  - type: GlobalArrivalRateChange
    multiplier: 1.0
    schedule:
      type: OneTime
      tick: 270

  # Late day (tick 285): Full collateral restoration
  - type: CollateralAdjustment
    agent: REGIONAL_TRUST
    delta: 1000000    # Restore remaining $10,000
    schedule:
      type: OneTime
      tick: 285

  - type: CollateralAdjustment
    agent: MOMENTUM_CAPITAL
    delta: 1000000    # Restore remaining $10,000
    schedule:
      type: OneTime
      tick: 285

# ============================================================================
# LSM CONFIGURATION
# ============================================================================

lsm_config:
  enable_bilateral: true
  enable_cycles: true
  max_cycle_length: 4         # All 4 agents can participate
  max_cycles_per_tick: 8

# ============================================================================
# COST CONFIGURATION
# ============================================================================

cost_rates:
  delay_cost_per_tick_per_cent: 0.0002       # $0.002 per $100 per tick
  overdraft_bps_per_tick: 0.8                # ~145% annualized
  collateral_cost_per_tick_bps: 0.0005       # ~9% annualized
  eod_penalty_per_transaction: 500000        # $5,000 per unsettled tx
  deadline_penalty: 250000                   # $2,500 per overdue tx
  overdue_delay_multiplier: 5.0              # 5x delay cost when overdue
  split_friction_cost: 7500                  # $75 per split

# ============================================================================
# EXPECTED DYNAMICS
# ============================================================================
#
# DAY 1 BASELINE (Ticks 0-99):
# - Settlement rate: 96-99%
# - Credit utilization: 15-30%
# - LSM activations: 3-8 (organic)
# - Collateral posted: Minimal
# - Costs: $300-$800 (baseline)
#
# DAY 2 CRISIS (Ticks 100-199):
# - Settlement rate: 88-94% (stressed)
# - Credit utilization: 50-75%
# - LSM activations: 25-45 (FORCED by large coordinated payments)
# - Large 4-agent cycle: $60K→$55K→$50K→$45K at ticks 110-116
# - Bilateral offset: $40K↔$38K at ticks 140-142
# - Collateral haircuts: $65K total (ticks 120, 122)
# - Activity surges: 2.5× → 3.0× → 1.5× → 1.0×
# - Payment splitting: HUB and REGIONAL split large payments
# - Costs: $4,000-$8,000 (elevated)
#
# DAY 3 RECOVERY (Ticks 200-299):
# - Settlement rate: 93-97% (recovering)
# - Credit utilization: 30-50% (declining)
# - LSM activations: 15-30
# - Collateral restoration: $55K restored (85% of losses)
# - 3-agent cycle stress test: $45K→$42K→$39K at tick 240
# - Activity surge: 1.8× → 1.0×
# - Costs: $1,500-$3,500 (declining)
#
# THREE-DAY TOTALS:
# - Average settlement rate: 92-96% (stressed but functional)
# - Total LSM operations: 43-83 (meaningful demonstration)
# - Bilateral offsets: 25-50
# - Multilateral cycles: 18-33
# - Peak credit usage: 50-75% (stressed, not maxed)
# - Collateral events: ~8-15 (posting + restoration + withdrawal)
# - Payment splits: 10-20 (strategic use)
# - Overdue transactions: 5-12 (contained)
# - Total costs: $5,800-$12,300 (realistic crisis costs)
#
# KEY INSIGHTS:
#
# 1. STRATEGIC LSM FORCING: Large coordinated payments (Day 2 ticks 110-116)
#    create a 4-agent cycle that MUST be resolved by LSM. This guarantees
#    LSM demonstration without relying on random starvation.
#
# 2. SHORTER DURATION: 3 days prevents cost compounding that creates death
#    spirals. Each day has clear purpose: baseline → crisis → recovery.
#
# 3. SURGE MULTIPLIERS: 2.5× and 3.0× activity surges create temporary
#    Queue 2 pressure without sustained overdrafts.
#
# 4. COLLATERAL LIFECYCLE: Haircuts (Day 2) → Restoration (Day 3) shows
#    full collateral management cycle in compressed timeframe.
#
# 5. BILATERAL + CYCLES: Explicit bilateral opportunity (ticks 140-142) +
#    multilateral cycles (ticks 110-116, 240) showcase all LSM types.
#
# 6. SPLITTING DEMONSTRATION: Large divisible payments force HUB and
#    REGIONAL to use splitting as tactical response.
#
# 7. SUSTAINABLE STRESS: Total resources ($760K balance + $570K credit =
#    $1,330K) vs daily outflow (~$280K) = 4.75× coverage. System is
#    stressed but never insolvent.
#
# 8. POLICY DIVERSITY: 4 distinct policies respond differently to same
#    stress events, demonstrating comparative performance.
#
# USAGE:
# ======
#
# # Run the scenario
# payment-sim run \
#   --config examples/configs/three_day_realistic_crisis.yaml \
#   --persist three_day_crisis.db \
#   --verbose
#
# # Check LSM activity
# duckdb three_day_crisis.db "
#   SELECT
#     tick / 100 as day,
#     COUNT(*) as lsm_events,
#     SUM(CASE WHEN event_type = 'lsm_bilateral_offset' THEN 1 ELSE 0 END) as bilaterals,
#     SUM(CASE WHEN event_type = 'lsm_cycle_settlement' THEN 1 ELSE 0 END) as cycles
#   FROM simulation_events
#   WHERE event_type IN ('lsm_bilateral_offset', 'lsm_cycle_settlement')
#   GROUP BY day
#   ORDER BY day;
# "
