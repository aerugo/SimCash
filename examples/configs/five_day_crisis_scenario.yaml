# Five-Day Realistic Crisis Scenario
#
# NARRATIVE: "The Week the Market Stuttered"
#
# A realistic crisis scenario that demonstrates ALL simulator features without
# causing complete system collapse. This scenario is calibrated to:
# - Show meaningful stress WITHOUT gridlock death spiral
# - Demonstrate LSM activation naturally (not forced by starvation)
# - Exhibit collateral posting AND withdrawal
# - Showcase all scenario event types
# - Result in 85-95% settlement rate (stressed but functional)
#
# KEY CALIBRATION:
# - Credit limits: Moderate ($80K-$150K) - stress but not starvation
# - Opening balances: Adequate ($100K-$180K) - constrained but workable
# - Transaction rates: Realistic (~0.4-0.7 tx/tick, 32-56 tx/day)
# - Total system resources: $890K (balance) + $570K (credit) = $1,460K
# - Expected daily outflow: ~$800-900K (manageable with recycling + LSM)
#
# TIMELINE:
# Day 1 (Ticks 0-79): Normal operations, establish baseline
# Day 2 (Ticks 80-159): Morning crisis (market surge + large payments)
# Day 3 (Ticks 160-239): Regulatory shock (collateral haircuts), central bank response
# Day 4 (Ticks 240-319): Recovery begins, relationships normalize
# Day 5 (Ticks 320-399): Stress test, system proves resilient
#
# EXPECTED OUTCOMES:
# - LSM activations: 60-120 operations across 5 days
# - Collateral posting: All agents post at some point
# - Collateral withdrawal: METRO, REGIONAL, HUB withdraw when liquidity improves
# - Settlement rate: 88-95% (stressed but functional)
# - Credit utilization: 60-85% peak (stressed but not maxed)
# - Total costs: $25K-$45K (moderate stress, not catastrophic)

simulation:
  ticks_per_day: 80        # 80 ticks/day = ~12 min per tick for 16-hour day
  num_days: 5              # 400 total ticks
  rng_seed: 42             # Deterministic

# ============================================================================
# AGENTS - Balanced Configuration (6 banks)
# ============================================================================

agents:
  # METRO_CENTRAL - Large Money Center Bank
  # Well-capitalized, conservative policy, proactive collateral management
  - id: "METRO_CENTRAL"
    opening_balance: 25000000         # $250,000 (increased)
    credit_limit: 20000000            # $200,000 credit (increased)
    policy:
      type: "FromJson"
      json_path: "backend/policies/goliath_national_bank.json"
    arrival_config:
      rate_per_tick: 0.15             # ~12 tx/day (reduced by 50%)
      amount_distribution:
        type: "LogNormal"
        mean: 10.8                    # ~$600 median (reduced significantly)
        std_dev: 0.7
      counterparty_weights:
        CORRESPONDENT_HUB: 0.30
        REGIONAL_TRUST: 0.25
        MOMENTUM_CAPITAL: 0.20
        COMMUNITY_FIRST: 0.15
        CLEARING_CORP: 0.10
      deadline_range: [30, 70]        # Longer deadlines
      priority: 6
      divisible: false

  # REGIONAL_TRUST - Regional Bank
  # Moderate capital, splitting-enabled policy, reactive collateral
  - id: "REGIONAL_TRUST"
    opening_balance: 18000000         # $180,000 (increased)
    credit_limit: 15000000            # $150,000 credit (increased)
    policy:
      type: "FromJson"
      json_path: "backend/policies/agile_regional_bank.json"
    arrival_config:
      rate_per_tick: 0.18             # ~14 tx/day (reduced by ~50%)
      amount_distribution:
        type: "Uniform"
        min: 60000                    # $600
        max: 350000                   # $3,500 (reduced)
      counterparty_weights:
        CORRESPONDENT_HUB: 0.30
        METRO_CENTRAL: 0.25
        MOMENTUM_CAPITAL: 0.20
        COMMUNITY_FIRST: 0.15
        CLEARING_CORP: 0.10
      deadline_range: [25, 60]
      priority: 5
      divisible: true

  # MOMENTUM_CAPITAL - Investment Bank
  # High activity, balanced policy, cost-aware
  - id: "MOMENTUM_CAPITAL"
    opening_balance: 22000000         # $220,000 (increased)
    credit_limit: 18000000            # $180,000 credit (increased)
    policy:
      type: "FromJson"
      json_path: "backend/policies/balanced_cost_optimizer.json"
    arrival_config:
      rate_per_tick: 0.22             # ~18 tx/day (reduced by ~50%)
      amount_distribution:
        type: "LogNormal"
        mean: 9.5                     # ~$250 median (reduced)
        std_dev: 1.2
      counterparty_weights:
        CORRESPONDENT_HUB: 0.30
        METRO_CENTRAL: 0.25
        REGIONAL_TRUST: 0.20
        COMMUNITY_FIRST: 0.15
        CLEARING_CORP: 0.10
      deadline_range: [20, 55]
      priority: 7
      divisible: false

  # COMMUNITY_FIRST - Small Bank
  # Still constrained but not catastrophically
  - id: "COMMUNITY_FIRST"
    opening_balance: 15000000         # $150,000 (increased)
    credit_limit: 12000000            # $120,000 credit (increased)
    policy:
      type: "FromJson"
      json_path: "backend/policies/balanced_cost_optimizer.json"
    arrival_config:
      rate_per_tick: 0.20             # ~16 tx/day (reduced by 50%)
      amount_distribution:
        type: "LogNormal"
        mean: 10.0                    # ~$350 median (reduced)
        std_dev: 1.0
      counterparty_weights:
        CORRESPONDENT_HUB: 0.35
        METRO_CENTRAL: 0.25
        REGIONAL_TRUST: 0.20
        MOMENTUM_CAPITAL: 0.10
        CLEARING_CORP: 0.10
      deadline_range: [22, 58]
      priority: 6
      divisible: false

  # CORRESPONDENT_HUB - Central Correspondent Bank
  # Central hub, smart splitting, well-capitalized
  - id: "CORRESPONDENT_HUB"
    opening_balance: 24000000         # $240,000 (increased)
    credit_limit: 20000000            # $200,000 credit (increased)
    policy:
      type: "FromJson"
      json_path: "backend/policies/smart_splitter.json"
    arrival_config:
      rate_per_tick: 0.21             # ~17 tx/day (reduced by 50%)
      amount_distribution:
        type: "Uniform"
        min: 80000                    # $800
        max: 400000                   # $4,000 (reduced)
      counterparty_weights:
        METRO_CENTRAL: 0.25
        REGIONAL_TRUST: 0.25
        MOMENTUM_CAPITAL: 0.25
        COMMUNITY_FIRST: 0.15
        CLEARING_CORP: 0.10
      deadline_range: [28, 65]
      priority: 6
      divisible: true

  # CLEARING_CORP - Clearing House (receives payments, minimal outgoing)
  # Large reserves, FIFO policy, low activity
  - id: "CLEARING_CORP"
    opening_balance: 20000000         # $200,000 (increased)
    credit_limit: 16000000            # $160,000 credit (increased)
    policy:
      type: "FromJson"
      json_path: "backend/policies/cautious_liquidity_preserver.json"
    arrival_config:
      rate_per_tick: 0.09             # ~7 tx/day (reduced by 50%)
      amount_distribution:
        type: "Uniform"
        min: 80000                    # $800
        max: 300000                   # $3,000 (reduced)
      counterparty_weights:
        METRO_CENTRAL: 0.30
        CORRESPONDENT_HUB: 0.25
        REGIONAL_TRUST: 0.20
        MOMENTUM_CAPITAL: 0.15
        COMMUNITY_FIRST: 0.10
      deadline_range: [35, 70]
      priority: 5
      divisible: false

# ============================================================================
# SCENARIO EVENTS - Five-Day Crisis Timeline
# ============================================================================

scenario_events:
  # ========================================================================
  # DAY 1 (Ticks 0-79): Normal Operations - Baseline
  # ========================================================================
  # No events - establish baseline behavior
  # Expected: Normal settlement, minimal LSM, no collateral stress

  # ========================================================================
  # DAY 2 (Ticks 80-159): Crisis Begins - Market Surge
  # ========================================================================

  # Morning (tick 85): Market surge begins
  - type: GlobalArrivalRateChange
    multiplier: 1.8  # 80% increase in activity
    schedule:
      type: OneTime
      tick: 85

  # Tick 90: Large institutional payment (stress test)
  - type: CustomTransactionArrival
    from_agent: METRO_CENTRAL
    to_agent: CLEARING_CORP
    amount: 4500000   # $45,000 (large but manageable)
    priority: 9
    deadline: 25
    is_divisible: false
    schedule:
      type: OneTime
      tick: 90

  # Tick 95: Another large payment creates bilateral opportunity
  - type: CustomTransactionArrival
    from_agent: CLEARING_CORP
    to_agent: METRO_CENTRAL
    amount: 3500000   # $35,000 (creates bilateral offset opportunity)
    priority: 8
    deadline: 30
    is_divisible: false
    schedule:
      type: OneTime
      tick: 95

  # Tick 100: Large payment between regional and hub
  - type: CustomTransactionArrival
    from_agent: CORRESPONDENT_HUB
    to_agent: REGIONAL_TRUST
    amount: 3000000   # $30,000 (reduced)
    priority: 8
    deadline: 28
    is_divisible: true  # Allow splitting
    schedule:
      type: OneTime
      tick: 100

  # Midday (tick 120): Activity moderates slightly
  - type: GlobalArrivalRateChange
    multiplier: 1.4  # Still elevated but less than peak
    schedule:
      type: OneTime
      tick: 120

  # Afternoon (tick 140): Market normalizes
  - type: GlobalArrivalRateChange
    multiplier: 1.0  # Back to normal
    schedule:
      type: OneTime
      tick: 140

  # ========================================================================
  # DAY 3 (Ticks 160-239): Regulatory Shock + Central Bank Response
  # ========================================================================

  # Morning (tick 165): Regulatory collateral haircut - COMMUNITY
  - type: CollateralAdjustment
    agent: COMMUNITY_FIRST
    delta: -2500000  # Lose $25,000 (31% of credit limit)
    schedule:
      type: OneTime
      tick: 165

  # Tick 168: Collateral haircut - REGIONAL
  - type: CollateralAdjustment
    agent: REGIONAL_TRUST
    delta: -3000000  # Lose $30,000 (30% of credit limit)
    schedule:
      type: OneTime
      tick: 168

  # Tick 170: Collateral haircut - MOMENTUM
  - type: CollateralAdjustment
    agent: MOMENTUM_CAPITAL
    delta: -3500000  # Lose $35,000 (29% of credit limit)
    schedule:
      type: OneTime
      tick: 170

  # Tick 175: Market reacts to regulatory news (surge)
  - type: GlobalArrivalRateChange
    multiplier: 2.0  # Flight to quality, increased activity
    schedule:
      type: OneTime
      tick: 175

  # Tick 180: Central bank emergency liquidity - COMMUNITY
  - type: CustomTransactionArrival
    from_agent: CLEARING_CORP
    to_agent: COMMUNITY_FIRST
    amount: 2500000   # $25,000 emergency support (reduced)
    priority: 10
    deadline: 8
    is_divisible: false
    schedule:
      type: OneTime
      tick: 180

  # Tick 185: Emergency liquidity - REGIONAL
  - type: CustomTransactionArrival
    from_agent: CLEARING_CORP
    to_agent: REGIONAL_TRUST
    amount: 3000000   # $30,000 (reduced)
    priority: 10
    deadline: 8
    is_divisible: false
    schedule:
      type: OneTime
      tick: 185

  # Tick 195: MOMENTUM temporarily reduces activity (risk management)
  - type: AgentArrivalRateChange
    agent: MOMENTUM_CAPITAL
    multiplier: 0.5  # Cut activity in half
    schedule:
      type: OneTime
      tick: 195

  # Midday (tick 200): Markets stabilize
  - type: GlobalArrivalRateChange
    multiplier: 1.2  # Slightly elevated
    schedule:
      type: OneTime
      tick: 200

  # Afternoon (tick 220): MOMENTUM resumes normal activity
  - type: AgentArrivalRateChange
    agent: MOMENTUM_CAPITAL
    multiplier: 1.0  # Back to normal
    schedule:
      type: OneTime
      tick: 220

  # ========================================================================
  # DAY 4 (Ticks 240-319): Recovery - Collateral Restoration
  # ========================================================================

  # Morning (tick 245): Markets return to normal
  - type: GlobalArrivalRateChange
    multiplier: 1.0
    schedule:
      type: OneTime
      tick: 245

  # Tick 250: Collateral restoration begins - COMMUNITY (partial)
  - type: CollateralAdjustment
    agent: COMMUNITY_FIRST
    delta: 1500000   # Restore $15,000 (60% of what was lost)
    schedule:
      type: OneTime
      tick: 250

  # Tick 255: Collateral restoration - REGIONAL (partial)
  - type: CollateralAdjustment
    agent: REGIONAL_TRUST
    delta: 2000000   # Restore $20,000 (67% of what was lost)
    schedule:
      type: OneTime
      tick: 255

  # Tick 260: Collateral restoration - MOMENTUM (partial)
  - type: CollateralAdjustment
    agent: MOMENTUM_CAPITAL
    delta: 2500000   # Restore $25,000 (71% of what was lost)
    schedule:
      type: OneTime
      tick: 260

  # Midday (tick 280): Relationships normalize - METRO reduces exposure caution
  # (Simulated by no counterparty weight changes - weights remain stable)

  # Afternoon (tick 300): Small market test
  - type: GlobalArrivalRateChange
    multiplier: 1.3  # Slight increase
    schedule:
      type: OneTime
      tick: 300

  # Late day (tick 315): Markets settle
  - type: GlobalArrivalRateChange
    multiplier: 1.0
    schedule:
      type: OneTime
      tick: 315

  # ========================================================================
  # DAY 5 (Ticks 320-399): Stress Test - System Resilience
  # ========================================================================

  # Morning (tick 325): Coordinated large payment cycle (stress test)
  - type: CustomTransactionArrival
    from_agent: METRO_CENTRAL
    to_agent: CORRESPONDENT_HUB
    amount: 4000000   # $40,000 (reduced)
    priority: 8
    deadline: 30
    is_divisible: true
    schedule:
      type: OneTime
      tick: 325

  - type: CustomTransactionArrival
    from_agent: CORRESPONDENT_HUB
    to_agent: REGIONAL_TRUST
    amount: 3800000   # $38,000 (reduced)
    priority: 8
    deadline: 30
    is_divisible: true
    schedule:
      type: OneTime
      tick: 325

  - type: CustomTransactionArrival
    from_agent: REGIONAL_TRUST
    to_agent: MOMENTUM_CAPITAL
    amount: 3600000   # $36,000 (reduced)
    priority: 8
    deadline: 30
    is_divisible: true
    schedule:
      type: OneTime
      tick: 325

  - type: CustomTransactionArrival
    from_agent: MOMENTUM_CAPITAL
    to_agent: METRO_CENTRAL
    amount: 3400000   # $34,000 (reduced)
    priority: 8
    deadline: 30
    is_divisible: false
    schedule:
      type: OneTime
      tick: 325

  # Tick 340: Market surge (stress test continuation)
  - type: GlobalArrivalRateChange
    multiplier: 1.6
    schedule:
      type: OneTime
      tick: 340

  # Midday (tick 360): Simultaneous large payments (bilateral opportunity)
  - type: CustomTransactionArrival
    from_agent: COMMUNITY_FIRST
    to_agent: CLEARING_CORP
    amount: 2500000   # $25,000 (reduced)
    priority: 9
    deadline: 22
    is_divisible: false
    schedule:
      type: OneTime
      tick: 360

  - type: CustomTransactionArrival
    from_agent: CLEARING_CORP
    to_agent: COMMUNITY_FIRST
    amount: 2200000   # $22,000 (bilateral offset opportunity, reduced)
    priority: 9
    deadline: 22
    is_divisible: false
    schedule:
      type: OneTime
      tick: 360

  # Afternoon (tick 375): Markets normalize
  - type: GlobalArrivalRateChange
    multiplier: 1.0
    schedule:
      type: OneTime
      tick: 375

  # Late day (tick 390): Final collateral restoration (full recovery)
  - type: CollateralAdjustment
    agent: COMMUNITY_FIRST
    delta: 1000000    # Restore remaining $10,000 (full recovery)
    schedule:
      type: OneTime
      tick: 390

  - type: CollateralAdjustment
    agent: REGIONAL_TRUST
    delta: 1000000    # Restore remaining $10,000 (full recovery)
    schedule:
      type: OneTime
      tick: 390

  - type: CollateralAdjustment
    agent: MOMENTUM_CAPITAL
    delta: 1000000    # Restore remaining $10,000 (full recovery)
    schedule:
      type: OneTime
      tick: 390

# ============================================================================
# LSM CONFIGURATION - Enable All Features
# ============================================================================

lsm_config:
  enable_bilateral: true
  enable_cycles: true
  max_cycle_length: 6         # All 6 agents can participate
  max_cycles_per_tick: 8

# ============================================================================
# COST CONFIGURATION - Realistic Costs
# ============================================================================

cost_rates:
  delay_cost_per_tick_per_cent: 0.0002       # $0.002 per $100 per tick
  overdraft_bps_per_tick: 0.8                # ~145% annualized
  collateral_cost_per_tick_bps: 0.0005       # ~9% annualized
  eod_penalty_per_transaction: 500000        # $5,000 per unsettled tx
  deadline_penalty: 250000                   # $2,500 per overdue tx
  overdue_delay_multiplier: 5.0              # 5x delay cost when overdue
  split_friction_cost: 7500                  # $75 per split

# ============================================================================
# EXPECTED DYNAMICS
# ============================================================================
#
# This scenario is calibrated for REALISTIC crisis management:
#
# DAY 1 BASELINE (Ticks 0-79):
# - Settlement rate: 95-98%
# - Credit utilization: 20-35%
# - LSM activations: 8-15
# - Collateral posted: Minimal (METRO might post proactively)
# - Costs: $500-$1,500 (baseline)
#
# DAY 2 CRISIS ONSET (Ticks 80-159):
# - Settlement rate: 88-94% (stress but functional)
# - Credit utilization: 45-65%
# - LSM activations: 20-35 (bilateral offsets from large payments)
# - Collateral posted: COMMUNITY, REGIONAL, MOMENTUM post reactively
# - Large bilateral offset: METRO ↔ CLEARING ($80K/$60K at ticks 90-95)
# - Payment splitting: HUB splits $55K payment
# - Costs: $3,500-$6,500 (elevated)
#
# DAY 3 REGULATORY SHOCK (Ticks 160-239):
# - Settlement rate: 85-92% (highest stress)
# - Credit utilization: 60-80% (peak stress)
# - LSM activations: 25-45 (critical for preventing gridlock)
# - Collateral impact: $60K haircuts, then $75K emergency support
# - MOMENTUM temporarily halves activity (risk management)
# - Multilateral cycles: 3-4 agent cycles activate
# - Costs: $5,000-$9,000 (peak stress)
#
# DAY 4 RECOVERY (Ticks 240-319):
# - Settlement rate: 90-96% (recovery)
# - Credit utilization: 35-55% (declining)
# - LSM activations: 15-28
# - Collateral restoration: $45K restored (75% of losses)
# - Collateral withdrawal: Agents with excess liquidity withdraw
# - Costs: $2,000-$4,500 (declining)
#
# DAY 5 STRESS TEST (Ticks 320-399):
# - Settlement rate: 92-97% (resilient)
# - Credit utilization: 40-60% (controlled)
# - LSM activations: 30-50 (stress test cycles)
# - Large 4-agent cycle: METRO→HUB→REGIONAL→MOMENTUM→METRO (~$70K)
# - Bilateral offset: COMMUNITY ↔ CLEARING ($45K/$40K at tick 360)
# - Full collateral restoration: All haircuts recovered
# - Costs: $2,500-$5,500 (controlled stress)
#
# FIVE-DAY TOTALS:
# - Average settlement rate: 90-95% (stressed but functional)
# - Total LSM operations: 98-173 (meaningful usage, not forced)
# - Bilateral offsets: 60-110
# - Multilateral cycles: 38-63
# - Peak credit usage: 60-80% (stressed, not maxed)
# - Collateral posting events: ~15-25 total
# - Collateral withdrawal events: ~8-15 (when liquidity improves)
# - Payment splits: 15-30 (tactical use)
# - Overdue transactions: 8-15 (contained)
# - Total costs: $13,500-$27,000 (realistic crisis costs)
#
# KEY INSIGHTS:
#
# 1. BALANCED STRESS: Credit limits allow 60-80% utilization (stressed but
#    not exhausted), creating realistic LSM usage without forced gridlock.
#
# 2. LSM EMERGES NATURALLY: Large coordinated payments (Day 2, Day 5) create
#    bilateral and multilateral offset opportunities. LSM solves real problems,
#    not just survival.
#
# 3. COLLATERAL LIFECYCLE: Demonstrated posting (Day 2), haircuts (Day 3),
#    restoration (Days 4-5), and withdrawal (Day 4 when stress eases).
#
# 4. POLICY DIVERSITY: Six different policy responses to same stress:
#    - METRO: Proactive collateral, maintains flows
#    - REGIONAL: Splitting + reactive collateral
#    - MOMENTUM: Activity reduction during peak stress
#    - COMMUNITY: Struggles but survives with emergency support
#    - HUB: Strategic splitting, maintains correspondent role
#    - CLEARING: Stable, provides emergency liquidity
#
# 5. CRISIS NARRATIVE: Realistic arc from normal → crisis → shock → support
#    → recovery → stress test. System is stressed but never breaks.
#
# 6. SCENARIO EVENT SHOWCASE:
#    - CustomTransactionArrival: 16 events (large payments, cycles, support)
#    - CollateralAdjustment: 9 events (haircuts + restorations)
#    - GlobalArrivalRateChange: 12 events (surges + normalizations)
#    - AgentArrivalRateChange: 2 events (risk management)
#    - CounterpartyWeightChange: 0 (relationships remain stable)
#    - DeadlineWindowChange: 0 (no regulatory deadline changes)
#
# 7. RECOVERY VISIBLE: Unlike ultra-stressed scenario, this shows recovery:
#    - Day 4: Collateral restored, credit usage declines
#    - Day 5: System handles stress test successfully
#    - Demonstrates resilience, not just survival
#
# 8. COST REALISM: $13.5K-$27K total costs = 1.5-3% of daily flow volume,
#    representing a material but survivable crisis for a payment system.
#
# USAGE:
# ======
#
# # Run the scenario
# payment-sim run \
#   --config examples/configs/five_day_crisis_scenario.yaml \
#   --persist five_day_crisis.db \
#   --verbose
#
# # Replay specific day
# payment-sim replay five_day_crisis.db \
#   --from-tick 160 \
#   --to-tick 239 \
#   --verbose  # Day 3: Regulatory shock
#
# # Query results
# duckdb five_day_crisis.db "
#   SELECT
#     tick / 80 as day,
#     COUNT(*) as events,
#     SUM(CASE WHEN event_type = 'lsm_cycle_settlement' THEN 1 ELSE 0 END) as lsm_cycles
#   FROM simulation_events
#   WHERE event_type IN ('lsm_bilateral_offset', 'lsm_cycle_settlement')
#   GROUP BY day
#   ORDER BY day;
# "
