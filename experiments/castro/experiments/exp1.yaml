# Experiment 1: 2-Period Deterministic
# Validates Nash equilibrium with deferred crediting.
#
# Setup:
# - 2 ticks per day, 1 day
# - Deterministic payment arrivals
# - Expected: Bank A posts 0, Bank B posts 20000
#
# Uses deterministic mode (single evaluation) since the scenario has
# no stochastic elements - all transactions are fixed at specific ticks.

name: exp1
description: "2-Period Deterministic Nash Equilibrium"

# Scenario configuration (relative to this file's directory)
scenario: ../configs/exp1_2period.yaml

# Evaluation settings
evaluation:
  mode: deterministic  # No bootstrap sampling - scenario is deterministic
  ticks: 2  # Only 2 ticks in scenario

# Convergence criteria
convergence:
  max_iterations: 25
  stability_threshold: 0.05
  stability_window: 5

# LLM configuration
llm:
  model: "openai:gpt-5.2"
  temperature: 0.0
  max_retries: 3
  timeout_seconds: 300
  reasoning_effort: "high"

# Prompt customization - replaces system_prompt with structured per-agent support
prompt_customization:
  all: |
    # Castro Initial Liquidity Game - 2-Period Deterministic

    You are optimizing a ONE-SHOT strategic decision: how much collateral to post at t=0.

    ## Game Setup (Castro et al. 2025, Section 6.3)
    - 2 periods (tick 0 and tick 1)
    - 2 banks: BANK_A and BANK_B
    - Fixed payment schedule (as fractions of collateral capacity B=100,000):
      * BANK_A -> BANK_B: 15000 cents = 0.15*B at tick 1 (deadline 2)
      * BANK_B -> BANK_A: 15000 cents = 0.15*B at tick 0 (deadline 1)
      * BANK_B -> BANK_A: 5000 cents = 0.05*B at tick 1 (deadline 2)
    - Deferred crediting: incoming payments become available next tick
    - max_collateral_capacity B = 100,000 cents per bank

    ## Cost Structure
    - Collateral cost: 500 bps/tick (posting collateral costs money)
    - Delay cost: 0.1 per tick per cent (holding payments costs money)
    - EOD penalty: 100,000 cents per unsettled transaction

    ## The Strategic Insight
    Bank B must send 20,000 total (15000 + 5000) = 0.20*B, so it needs liquidity.
    Bank A receives 15,000 from Bank B at tick 0 (available tick 1 via deferred crediting).
    Bank A's only outgoing payment (15,000 at tick 1) can be funded by incoming liquidity.

    **Nash Equilibrium: Bank A posts 0.0, Bank B posts 0.20** (20% of B = 20,000 cents).

    ## Your Task
    Generate a policy that chooses `initial_liquidity_fraction` - the fraction of
    max_collateral_capacity to post at t=0.

    ## Policy Structure (JSON)
    {
      "version": "2.0",
      "policy_id": "<agent_id>_policy",
      "parameters": {
        "initial_liquidity_fraction": <float 0.0-1.0>
      },
      "payment_tree": {
        "type": "action",
        "node_id": "release_all",
        "action": "Release"
      },
      "strategic_collateral_tree": {
        "type": "condition",
        "node_id": "check_tick_0",
        "condition": {
          "op": "==",
          "left": {"field": "system_tick_in_day"},
          "right": {"value": 0}
        },
        "on_true": {
          "type": "action",
          "node_id": "post_initial",
          "action": "PostCollateral",
          "parameters": {
            "amount": {
              "compute": {
                "op": "*",
                "left": {"param": "initial_liquidity_fraction"},
                "right": {"field": "remaining_collateral_capacity"}
              }
            },
            "reason": {"value": "InitialAllocation"}
          }
        },
        "on_false": {
          "type": "action",
          "node_id": "hold_collateral",
          "action": "HoldCollateral"
        }
      }
    }

    RULES:
    - Every node MUST have a unique "node_id" string field
    - payment_tree: Use "Release" for this simple game
    - strategic_collateral_tree: Post collateral at tick 0 only
    - The ONLY parameter to tune is initial_liquidity_fraction
    - Output ONLY valid JSON, no markdown or explanation
  BANK_A: |
    **For BANK_A: The optimal initial_liquidity_fraction is 0.0**
    You can fund your outgoing payment (15,000 at tick 1) using incoming liquidity
    from BANK_B's payment that arrives at tick 0 (available at tick 1 via deferred crediting).
  BANK_B: |
    **For BANK_B: The optimal initial_liquidity_fraction is 0.20** (20,000 / 100,000)
    You must send 20,000 total (15,000 + 5,000), and you cannot rely on incoming payments
    since BANK_A's payment arrives at tick 1 (available at tick 2 via deferred crediting).

# Policy constraints (Castro-specific - MINIMAL SET)
# The Initial Liquidity Game has ONE decision: what fraction to post at t=0
policy_constraints:
  allowed_parameters:
    # THE ONLY DECISION VARIABLE - fraction of collateral to post at t=0
    - name: initial_liquidity_fraction
      param_type: float
      min_value: 0.0
      max_value: 1.0
      description: "Fraction of max_collateral_capacity to post at t=0. Expected optimal: Bank A = 0.0, Bank B = 0.20 (20000/100000)"

  allowed_fields:
    # MINIMAL SET - only what's needed for Castro Initial Liquidity Game
    # Time context - distinguish t=0 (collateral posting) from t>=1
    - system_tick_in_day
    # Agent liquidity state
    - balance
    # Collateral state
    - remaining_collateral_capacity
    - posted_collateral
    - max_collateral_capacity
    # Transaction context (for payment_tree decisions)
    - ticks_to_deadline

  allowed_actions:
    payment_tree:
      - Release
      - Hold
    bank_tree:
      - NoAction
    strategic_collateral_tree:
      - PostCollateral
      - HoldCollateral

# Agents to optimize
optimized_agents:
  - BANK_A
  - BANK_B

# Output settings
output:
  directory: results
  database: exp1.db
  verbose: true

# Master seed for reproducibility
master_seed: 42
